{% extends 'layout.html' %}
{% block content %}

<div class="container mb-4 pt-4">
    <div class="row">
        <div class="col-9">
            <h1>Perfumes</h1>
        </div>
        <div class="col-3">
            <a href="{{ url_for('perfumes') }}" class="btn btn-primary float-right" type="button">Back to all
                perfumes</a>
        </div>
    </div>
</div>
<div class="card">
    <h5 class="card-header text-white bg-primary">
        {{ perfume.name }}
        </a>
    </h5>
    <div class="card-body">
        <h4>Name: <a href="{{ url_for('perfume', id=perfume._id) }}"> {{ perfume.name }}</a></h4>
        <h5>A perfume by <span class="lead text-primary font-weight-bold">{{ perfume.brand }}</span></h5>
        <p>Type: {{ perfume.perfume_type }}</p>
    </div>
    <div class="container pb-5">
        <div class="row justify-content-center">
            <div class="col-7">
                <div class="card-body">
                    {{ perfume.description | safe}}
                </div>
            </div>
            <div class="col-4">
                <img class="float-right picture-perfume" src="{{ url_for('static', filename='images/perfume_pics/' + perfume.picture) }}" onerror="if (this.src != '../static/images/perfume_pics/generic.png') this.src = '../static/images/perfume_pics/generic.png';" loading="lazy" alt="Perfume">
            </div>
        </div>

    </div>
    <hr>
    <div class="container pt-2 pb-4">
        <div class="row">
            {% for item in cursor %}
            <div class="col-7">
                Posted by <span class="text-success">{{ item['username'] }}</span>
                <span class="text-muted">({{ item['firstName']}} {{ item['lastName']}})</span>
                on {{ perfume.date_updated.strftime('%d-%m-%Y') }}<br>
                {% if current_user.is_authenticated %}
                <button type="button" class="btn btn-success btn-sm mt-2" data-toggle="modal" data-target="#reviewPerfumeModal">Review</button>
                {% else %}
                <button disabled type="button" class="btn btn-success btn-sm mt-2" data-toggle="modal" data-target="#reviewPerfumeModal">Review</button>
                <span class="ml-3">Please login to review</span>
                {% endif %}
                {% if current_user.is_authenticated and current_user.is_admin == True and current_user.username == perfume.author %}

                <a href="{{ url_for('edit_perfume', id=perfume._id) }}" class="btn btn-primary btn-sm mt-2">Edit</a>
                <button type="button" class="btn btn-danger btn-sm mt-2" data-toggle="modal" data-target="#deletePerfumeModal">Delete</button>
                {% elif current_user.is_authenticated and current_user.is_admin == True %}
                <a href="{{ url_for('edit_perfume', id=perfume._id) }}" class="btn btn-primary btn-sm mt-2">Edit</a>
                <button disabled type="button" class="btn btn-danger btn-sm mt-2" data-toggle="modal" data-target="#deletePerfumeModal">Delete</button>
                <span class="small ml-2">Only the author can delete this perfume. You can still edit it.</span>
                {% endif %}
            </div>
            <div class="col-4">
                <img class="float-right avatar-perfume" src="{{ url_for('static', filename='images/avatars/' + item['profilePicture']) }}" onerror="if (this.src != '../static/images/avatars/default.png') this.src = '../static/images/avatars/default.png';" loading="lazy" alt="Avatar">
            </div>
            <div class="col mt-3">
            </div>
            {% endfor %}
        </div>
    </div>
</div>
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-12">
            <h3 class="text-center">Reviews</h3>
            <ul class='reviews'>

                {% for item in perfume.reviews|reverse %}
                <div class="card container">
                    <div class="row">
                        <div class="card-header col-9">
                            <h5>{{item['reviewer'] }} said on {{ item.date_reviewed.strftime('%d-%m-%Y') }}</h5>
                        </div>
                        <div class="card-header col-3">
                            {% if current_user.username == item['reviewer'] %}
                            <button type="button" class="btn btn-danger btn-sm mt-2 delete-review float-right ml-2" data-perfume_id="{{perfume['_id']}}" data-review_id="{{item['_id']}}" data-toggle="modal" data-target="#deleteReviewModal">Delete</button>

                            <a href="{{ url_for('edit_review', review_id=item._id, perfume_id=perfume._id) }}" class="float-right btn btn-success btn-sm mt-2 px-3">Edit</a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="p-3 row">
                        <div class="col-1">
                            <img class="avatar-perfume float-right" src="{{ url_for('static', filename='images/avatars/' + item['reviewer_picture']) }}" onerror="if (this.src != '../static/images/avatars/default.png') this.src = '../static/images/avatars/default.png';" loading="lazy" alt="Avatar">
                        </div>
                        <div class=" col-10">
                            <li>{{ item['review_content'] | safe }}</li>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if not perfume.reviews %}
                <h5 class="text-center">
                    There are no reviews for this perfume
                </h5>
                {% endif %}
            </ul>
        </div>
    </div>
</div>
<!-- MODALS -->
<!-- DELETE REVIEW MODAL -->
<div class="modal fade" id="deleteReviewModal" tabindex="-1" role="dialog" aria-labelledby="deleteReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteReviewModal">Please Confirm</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Please confirm you want to delete your review.</p>
                <p><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <form id="form-delete-review" action="{{ url_for('delete_review') }}" method="POST">
                    <input hidden name="review_id">
                    <input hidden name="perfume_id">
                    <input type="submit" class="btn btn-danger" value="Delete">
                </form>
            </div>
        </div>
    </div>
</div>
<!-- DELETE MODAL -->
<div class="modal fade" id="deletePerfumeModal" tabindex="-1" role="dialog" aria-labelledby="deletePerfumeModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteUserModal">Please Confirm Deletion</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Please confirm you want to delete this perfume: {{ perfume.name }}.</p>
                <p><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <form action="{{ url_for('delete_perfume', id=perfume._id) }}" method="POST">
                    <input type="submit" , class="btn btn-danger" value="Delete">
                </form>
            </div>
        </div>
    </div>
</div>
<!-- REVIEW MODAL -->
<div class="modal fade" id="reviewPerfumeModal" tabindex="-1" role="dialog" aria-labelledby="reviewPerfumeModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteUserModal">Please Leave a Review</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method=POST action="{{ url_for('review_perfume', id=perfume._id) }}" id="form-review">
                    {{ form.hidden_tag() }}
                    <fieldset class="form-group">
                        <div class="form-group">
                            {% if form.review.errors %}
                            {{ form.review(class="form-control form-control-md is-invalid")}}
                            <div class="invalid-feedback">
                                {% for error in form.review.errors %}
                                <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                            {% else %}
                            {{ form.review(class="form-control form-control-md", placeholder="Review", id="description")}}
                            {% endif %}
                        </div>
                    </fieldset>
                    <div class="modal-footer">
                        <div class="form-group">
                            {{ form.submit(class="btn btn-primary")}}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
{% block CKEditor_js %}
    <script src="{{ url_for('static', filename='js/cke.js') }}"></script>
{% endblock CKEditor_js %}